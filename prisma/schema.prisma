generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String  @id @default(cuid())
  email      String  @unique
  firstName  String?
  lastName   String?
  password   String?
  tenantId   String?
  status     String  @default("PENDING")
  setupToken String?

  memberships    Membership[]
  createdClinics Clinic[]     @relation("ClinicCreatedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Clinic {
  id          String       @id @default(cuid())
  name        String
  tenantId    String       @unique
  memberships Membership[]
  createdById String?
  createdBy   User?        @relation("ClinicCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  services     Service[]
  patients     Patient[]
  appointments Appointment[]

  currency       String? @default("TND")
  taxRate        Float?  @default(0)
  stripeTestMode Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdById])
}

model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  permissions RolePermission[]
  memberships Membership[]
}

model Permission {
  id    String           @id @default(cuid())
  name  String           @unique
  roles RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

model Membership {
  id       String @id @default(cuid())
  userId   String
  clinicId String
  roleId   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Restrict)

  appointments  Appointment[]
  consultations Consultation[] // ✅ relation inverse des consultations

  @@unique([userId, clinicId])
  @@index([userId])
  @@index([clinicId])
  @@index([roleId])
}

model Service {
  id       String @id @default(cuid())
  name     String
  duration Int
  price    Float
  clinicId String

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  appointments Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clinicId])
}

model Patient {
  id        String    @id @default(cuid())
  firstName String
  lastName  String
  email     String?   @unique
  phone     String?
  birthDate DateTime?
  gender    String?
  address   String?
  clinicId  String
  clinic    Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  appointments Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Appointment {
  id       String   @id @default(cuid())
  date     DateTime
  status   String   @default("scheduled")
  notes    String?
  clinicId String
  clinic   Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  staffId String?
  staff   Membership? @relation(fields: [staffId], references: [id], onDelete: SetNull)

  consultation Consultation? // ✅ relation inverse obligatoire

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Consultation {
  id        String   @id @default(cuid())
  date      DateTime @default(now())
  symptoms  String?
  diagnosis String?
  notes     String?
  treatment String?

  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  doctorId String
  doctor   Membership @relation(fields: [doctorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
